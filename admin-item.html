<!DOCTYPE html>
<html lang="en-IN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Add Items (Offline)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            padding: 15px;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Header */
        .admin-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 12px 20px;
            text-align: center;
            border-bottom: 5px solid #d32f2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            font-size: 26px;
            margin: 0;
            font-weight: 700;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .add-btn {
            background: #4CAF50;
            color: black;
            border: none;
            padding: 10px 25px;
            font-size: 16px;
            font-weight: 800;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .add-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.25);
        }
        
        .add-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Image Upload */
        .image-section {
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .upload-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .browse-btn {
            background: #1565c0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .browse-btn:hover {
            background: #0d47a1;
            transform: translateY(-2px);
        }
        
        .image-info {
            color: #666;
            font-size: 13px;
        }
        
        .image-preview-container {
            margin-top: 12px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .preview-img {
            width: 300px;
            height: 200px;
            border-radius: 5px;
            border: 2px solid #ddd;
            object-fit: contain;
            background: white;
        }
        
        .download-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .download-btn i {
            font-size: 14px;
        }
        
        /* Crop Modal */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .crop-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
        }
        
        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .crop-header h3 {
            color: #333;
            font-size: 18px;
        }
        
        .close-crop {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .crop-area {
            width: 100%;
            height: 350px;
            background: #f0f0f0;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        
        #cropImage {
            max-width: 100%;
            max-height: 100%;
            position: absolute;
            cursor: move;
        }
        
        .crop-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 200px;
            border: 2px dashed #1565c0;
            background: rgba(21, 101, 192, 0.1);
            pointer-events: none;
            z-index: 10;
        }
        
        .crop-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .zoom-btn {
            background: #1565c0;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #0d47a1;
        }
        
        .crop-actions {
            display: flex;
            gap: 8px;
        }
        
        .crop-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Two Column Layout */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            padding: 25px;
            align-items: stretch;
        }
        
        .form-column {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            border: 2px solid #ccc;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .form-group textarea {
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
        }
        
        /* Height for Specifications and Descriptions */
        #specifications {
            min-height: 120px;
        }
        
        #descriptions {
            min-height: 120px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #1565c0;
            outline: none;
            box-shadow: 0 0 5px rgba(21, 101, 192, 0.3);
        }
        
        /* Line Counter */
        .line-counter {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-family: monospace;
        }
        
        .line-counter.error {
            color: #d32f2f;
            font-weight: bold;
        }
        
        /* Default Keywords Container */
        .default-keywords-container {
            padding: 20px 25px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        
        .default-keywords-container .form-group {
            margin-bottom: 0;
        }
        
        .default-keywords-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        #defaultKeywords {
            min-height: 100px;
            font-family: monospace;
            font-size: 13px;
            background-color: #f0f0f0;
            color: #333;
        }
        
        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10001;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .two-columns {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .crop-area {
                height: 300px;
            }
            
            .crop-overlay {
                width: 250px;
                height: 166px;
            }
            
            .image-preview-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .admin-header h1 {
                font-size: 22px;
            }
            
            .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .add-btn {
                width: 100%;
                max-width: 200px;
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .admin-header {
                padding: 12px;
            }
            
            .upload-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .crop-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .crop-area {
                height: 250px;
            }
            
            .crop-overlay {
                width: 200px;
                height: 133px;
            }
            
            .image-preview-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .preview-img {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
    <!-- Font Awesome for download icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Admin - Add Items (Offline)</h1>
            <div class="header-right">
                <button class="add-btn" id="addBtn">Add to List</button>
            </div>
        </div>
        
        <!-- Image Upload -->
        <div class="image-section">
            <div class="upload-container">
                <button class="browse-btn" id="browseBtn">
                    Browse Image
                </button>
                <div class="image-info">
                    <div>Selected: <span id="fileName">No file selected</span></div>
                    <div>Will be saved as: <span id="saveName">edu1.jpg</span></div>
                </div>
            </div>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <div class="image-preview-container">
                <button class="download-btn" id="downloadBtn" style="display: none;">
                    <i class="fas fa-download"></i> Download Image
                </button>
            </div>
        </div>
        
        <!-- Two Column Form -->
        <div class="two-columns">
            <!-- Left Column -->
            <div class="form-column">
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category">
                        <option value="">Select Category</option>
                        <option value="Education">Education</option>
                        <option value="Medical">Medical</option>
                        <option value="Scientific">Scientific</option>
                        <option value="Industry">Industry</option>
                        <option value="Research">Research</option>
                        <option value="Project">Project</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="imagePath">Image Path:</label>
                    <input type="text" id="imagePath" placeholder="Auto-Fill" readonly>
                </div>
                
                <div class="form-group">
                    <label for="itemName">Item Name (max 25 chars):</label>
                    <input type="text" id="itemName" placeholder="Type here..." maxlength="25">
                </div>
                
                <div class="form-group">
                    <label for="mrpPrice">MRP Price (INR):</label>
                    <input type="text" id="mrpPrice" placeholder="e.g., 100000">
                </div>
                
                <div class="form-group">
                    <label for="discount">Discount (%):</label>
                    <input type="number" id="discount" placeholder="e.g., 5" min="0" max="100" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="buyPrice">Buy Price (INR):</label>
                    <input type="text" id="buyPrice" placeholder="Auto-Fill" readonly>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="form-column">
                <div class="form-group">
                    <label for="warranty">Warranty (max 40 chars):</label>
                    <input type="text" id="warranty" placeholder="Type here..." maxlength="40">
                </div>
                
                <div class="form-group">
                    <label for="specifications">Specifications (max 6 lines, 40 chars each):</label>
                    <textarea id="specifications" placeholder="Type here..." maxlength="240"></textarea>
                    <div class="line-counter">
                        <span id="specsLineCount">0</span>/6 lines | Max line: <span id="specsMaxChars">0</span>/40 chars
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="descriptions">Descriptions (max 6 lines, 40 chars each):</label>
                    <textarea id="descriptions" placeholder="Type here..." maxlength="240"></textarea>
                    <div class="line-counter">
                        <span id="descLineCount">0</span>/6 lines | Max line: <span id="descMaxChars">0</span>/40 chars
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Default Keywords Container -->
        <div class="default-keywords-container">
            <div class="form-group">
                <label for="defaultKeywords">Default Keywords (Auto-filled based on category):</label>
                <textarea id="defaultKeywords" placeholder="Default keywords will appear here..." readonly></textarea>
            </div>
        </div>
    </div>
    
    <!-- Crop Modal -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-container">
            <div class="crop-header">
                <h3>Crop Image (300x200 pixels)</h3>
                <button class="close-crop" id="closeCrop">Ã— Close</button>
            </div>
            
            <div class="crop-area" id="cropArea">
                <img id="cropImage" src="" alt="Image to crop">
                <div class="crop-overlay"></div>
            </div>
            
            <div class="crop-controls">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut">-</button>
                    <span id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">+</button>
                </div>
                
                <div class="crop-actions">
                    <button class="cancel-btn" id="cancelCrop">Cancel</button>
                    <button class="crop-btn" id="applyCrop">Crop Image</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Message -->
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i> Item added successfully!
    </div>

    <script>
        // DOM Elements
        const browseBtn = document.getElementById('browseBtn');
        const imageInput = document.getElementById('imageInput');
        const fileNameSpan = document.getElementById('fileName');
        const saveNameSpan = document.getElementById('saveName');
        const downloadBtn = document.getElementById('downloadBtn');
        const categorySelect = document.getElementById('category');
        const imagePathInput = document.getElementById('imagePath');
        const itemNameInput = document.getElementById('itemName');
        const mrpPriceInput = document.getElementById('mrpPrice');
        const discountInput = document.getElementById('discount');
        const buyPriceInput = document.getElementById('buyPrice');
        const warrantyInput = document.getElementById('warranty');
        const defaultKeywordsInput = document.getElementById('defaultKeywords');
        const specificationsInput = document.getElementById('specifications');
        const descriptionsInput = document.getElementById('descriptions');
        const addBtn = document.getElementById('addBtn');
        const successMessage = document.getElementById('successMessage');
        
        // Counter Elements
        const specsLineCount = document.getElementById('specsLineCount');
        const specsMaxChars = document.getElementById('specsMaxChars');
        const descLineCount = document.getElementById('descLineCount');
        const descMaxChars = document.getElementById('descMaxChars');
        
        // Crop Modal Elements
        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const closeCropBtn = document.getElementById('closeCrop');
        const cancelCropBtn = document.getElementById('cancelCrop');
        const applyCropBtn = document.getElementById('applyCrop');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const zoomLevelSpan = document.getElementById('zoomLevel');
        
        // Variables
        let selectedFile = null;
        let croppedImageData = null;
        let originalImage = null;
        let scale = 1;
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        let itemCounters = {
            Education: 1,
            Medical: 1,
            Scientific: 1,
            Industry: 1,
            Research: 1,
            Project: 1
        };
        
        // Default keywords for each category
        const defaultKeywords = {
            Education: "Kolkata West Bengal education lab equipment, Patna Bihar school laboratory instruments, Guwahati Assam biology lab apparatus, Bhubaneswar Odisha physics lab tools, Ranchi Jharkhand chemistry lab supplies, Siliguri North Bengal educational instruments, Northeast India Eastern region academic equipment, Durgapur Asansol industrial area school tools, Jamshedpur industrial city lab apparatus, Rourkela steel city educational supplies, Eastern India school laboratory equipment, Bengal Bihar Odisha Assam academic instruments, Kolkata Howrah school science equipment, Patna Gaya educational tools, Guwahati Dibrugarh Northeast lab supplies",
            Medical: "Kolkata West Bengal medical laboratory equipment, Patna Bihar clinical diagnostic instruments, Guwahati Assam hospital lab supplies, Bhubaneswar Odisha pathology lab tools, Ranchi Jharkhand medical research equipment, Siliguri North Bengal healthcare instruments, Northeast India Eastern region medical apparatus, Durgapur Asansol hospital laboratory tools, Jamshedpur industrial city medical equipment, Rourkela steel city clinical supplies, Eastern India medical laboratory instruments, Bengal Bihar Odisha Assam healthcare tools, Kolkata medical college equipment, Patna AIIMS diagnostic instruments, Guwahati medical university lab supplies",
            Scientific: "Kolkata West Bengal scientific research equipment, Patna Bihar laboratory testing instruments, Guwahati Assam analytical laboratory apparatus, Bhubaneswar Odisha research lab tools, Ranchi Jharkhand measurement instruments, Siliguri North Bengal scientific lab supplies, Northeast India Eastern region experimental equipment, Durgapur Asansol industrial testing devices, Jamshedpur Tata research instruments, Rourkela industrial measurement tools, Eastern India scientific laboratory equipment, Bengal Bihar Odisha Assam research apparatus, Kolkata IIT research instruments, Patna NIT laboratory tools, Guwahati university scientific equipment",
            Industry: "Kolkata West Bengal industrial laboratory equipment, Patna Bihar quality control instruments, Guwahati Assam testing lab apparatus, Bhubaneswar Odisha manufacturing lab tools, Ranchi Jharkhand industrial research equipment, Siliguri North Bengal factory lab supplies, Northeast India Eastern region production devices, Durgapur Asansol steel plant instruments, Jamshedpur industrial testing equipment, Rourkela factory quality tools, Eastern India industrial laboratory instruments, Bengal Bihar Odisha Assam manufacturing apparatus, Kolkata industrial area testing equipment, Patna industrial estate lab tools, Guwahati industrial growth center supplies",
            Research: "Kolkata West Bengal research laboratory equipment, Patna Bihar scientific research instruments, Guwahati Assam experimental lab apparatus, Bhubaneswar Odisha R&D lab tools, Ranchi Jharkhand academic research equipment, Siliguri North Bengal innovation lab supplies, Northeast India Eastern region advanced instruments, Durgapur Asansol research center tools, Jamshedpur R&D laboratory equipment, Rourkela innovation center apparatus, Eastern India research laboratory instruments, Bengal Bihar Odisha Assam experimental tools, Kolkata CSIR research equipment, Patna research institute instruments, Guwahati agricultural research supplies",
            Project: "Kolkata West Bengal project laboratory equipment, Patna Bihar engineering lab instruments, Guwahati Assam student project apparatus, Bhubaneswar Odisha DIY lab tools, Ranchi Jharkhand prototype testing equipment, Siliguri North Bengal experimental project supplies, Northeast India Eastern region model making tools, Durgapur Asansol engineering college equipment, Jamshedpur student project instruments, Rourkela prototype development tools, Eastern India project laboratory apparatus, Bengal Bihar Odisha Assam engineering tools, Kolkata engineering college project equipment, Patna polytechnic institute tools, Guwahati university project supplies"
        };
        
        // File paths for each category
        const filePaths = {
            Education: "education.txt",
            Medical: "medical.txt",
            Scientific: "scientific.txt",
            Industry: "industry.txt",
            Research: "research.txt",
            Project: "project.txt"
        };
        
        // Image paths for each category (for JSON)
        const jsonImagePaths = {
            Education: "/sparrowinstruments/imgedu/edu",
            Medical: "/sparrowinstruments/imgmed/med",
            Scientific: "/sparrowinstruments/imgsci/sci",
            Industry: "/sparrowinstruments/imgind/ind",
            Research: "/sparrowinstruments/imgres/res",
            Project: "/sparrowinstruments/imgpro/pro"
        };
        
        // Initialize
        function init() {
            // Try to load existing counters from localStorage
            const savedCounters = localStorage.getItem('itemCounters');
            if (savedCounters) {
                itemCounters = JSON.parse(savedCounters);
            }
            
            // Add event listeners
            browseBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageSelect);
            categorySelect.addEventListener('change', handleCategoryChange);
            itemNameInput.addEventListener('input', capitalizeFirstLetters);
            mrpPriceInput.addEventListener('input', formatMRPPrice);
            mrpPriceInput.addEventListener('input', calculateBuyPrice);
            discountInput.addEventListener('input', calculateBuyPrice);
            
            // Specifications and Descriptions counters
            specificationsInput.addEventListener('input', updateSpecsCounter);
            descriptionsInput.addEventListener('input', updateDescCounter);
            
            addBtn.addEventListener('click', addItem);
            downloadBtn.addEventListener('click', downloadImage);
            
            // Crop Modal Events
            closeCropBtn.addEventListener('click', closeCropModal);
            cancelCropBtn.addEventListener('click', closeCropModal);
            applyCropBtn.addEventListener('click', applyCrop);
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            
            // Initialize
            handleCategoryChange();
            updateSpecsCounter();
            updateDescCounter();
        }
        
        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                fileNameSpan.textContent = file.name;
                
                // Show crop modal
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage = new Image();
                    originalImage.onload = function() {
                        cropImage.src = e.target.result;
                        showCropModal();
                    };
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Show crop modal
        function showCropModal() {
            cropModal.style.display = 'flex';
            scale = 1;
            updateZoomDisplay();
            
            // Center the image
            setTimeout(() => {
                const cropArea = document.getElementById('cropArea');
                const imgWidth = cropImage.naturalWidth;
                const imgHeight = cropImage.naturalHeight;
                
                // Set initial scale to fit
                const containerWidth = cropArea.clientWidth;
                const containerHeight = cropArea.clientHeight;
                
                // Calculate scale to fit image in container
                const scaleX = containerWidth / imgWidth;
                const scaleY = containerHeight / imgHeight;
                scale = Math.min(scaleX, scaleY) * 0.8;
                
                updateImageTransform();
                
                // Center the image
                cropImage.style.left = (cropArea.clientWidth - (imgWidth * scale)) / 2 + 'px';
                cropImage.style.top = (cropArea.clientHeight - (imgHeight * scale)) / 2 + 'px';
                
                // Add drag event listeners
                cropImage.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                
                cropImage.addEventListener('touchstart', startDragTouch);
                document.addEventListener('touchmove', dragTouch);
                document.addEventListener('touchend', stopDrag);
            }, 100);
        }
        
        // Close crop modal
        function closeCropModal() {
            cropModal.style.display = 'none';
            // Remove event listeners
            cropImage.removeEventListener('mousedown', startDrag);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            
            cropImage.removeEventListener('touchstart', startDragTouch);
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('touchend', stopDrag);
        }
        
        // Drag functionality
        function startDrag(e) {
            isDragging = true;
            startX = e.clientX - cropImage.offsetLeft;
            startY = e.clientY - cropImage.offsetTop;
            initialX = cropImage.offsetLeft;
            initialY = cropImage.offsetTop;
        }
        
        function startDragTouch(e) {
            if (e.touches.length === 1) {
                isDragging = true;
                const touch = e.touches[0];
                startX = touch.clientX - cropImage.offsetLeft;
                startY = touch.clientY - cropImage.offsetTop;
                initialX = cropImage.offsetLeft;
                initialY = cropImage.offsetTop;
            }
        }
        
        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const x = e.clientX - startX;
            const y = e.clientY - startY;
            
            cropImage.style.left = x + 'px';
            cropImage.style.top = y + 'px';
        }
        
        function dragTouch(e) {
            if (!isDragging || e.touches.length !== 1) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const x = touch.clientX - startX;
            const y = touch.clientY - startY;
            
            cropImage.style.left = x + 'px';
            cropImage.style.top = y + 'px';
        }
        
        function stopDrag() {
            isDragging = false;
        }
        
        // Zoom functionality
        function zoomIn() {
            scale += 0.1;
            updateImageTransform();
            updateZoomDisplay();
        }
        
        function zoomOut() {
            if (scale > 0.2) {
                scale -= 0.1;
                updateImageTransform();
                updateZoomDisplay();
            }
        }
        
        function updateImageTransform() {
            const imgWidth = cropImage.naturalWidth * scale;
            const imgHeight = cropImage.naturalHeight * scale;
            
            cropImage.style.width = imgWidth + 'px';
            cropImage.style.height = imgHeight + 'px';
        }
        
        function updateZoomDisplay() {
            zoomLevelSpan.textContent = Math.round(scale * 100) + '%';
        }
        
        // Apply crop
        function applyCrop() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas to 300x200 pixels
            const outputWidth = 300;
            const outputHeight = 200;
            canvas.width = outputWidth;
            canvas.height = outputHeight;
            
            // Fill with white background first
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, outputWidth, outputHeight);
            
            const cropArea = document.getElementById('cropArea');
            const overlay = document.querySelector('.crop-overlay');
            
            // Calculate crop coordinates
            const overlayRect = overlay.getBoundingClientRect();
            const cropAreaRect = cropArea.getBoundingClientRect();
            const imgRect = cropImage.getBoundingClientRect();
            
            // Calculate relative positions
            const cropX = (overlayRect.left - imgRect.left) / scale;
            const cropY = (overlayRect.top - imgRect.top) / scale;
            const cropWidth = overlayRect.width / scale;
            const cropHeight = overlayRect.height / scale;
            
            // Draw cropped image to canvas with white background
            ctx.drawImage(
                originalImage,
                cropX, cropY, cropWidth, cropHeight,
                0, 0, outputWidth, outputHeight
            );
            
            // Convert to data URL
            croppedImageData = canvas.toDataURL('image/jpeg', 0.9);
            
            // Show download button only (no preview image)
            downloadBtn.style.display = 'flex';
            
            closeCropModal();
        }
        
        // Handle category change
        function handleCategoryChange() {
            const category = categorySelect.value;
            
            if (category) {
                // Update image path
                const counter = itemCounters[category];
                imagePathInput.value = jsonImagePaths[category] + counter + ".jpg";
                
                // Update default keywords (non-editable)
                defaultKeywordsInput.value = defaultKeywords[category];
                
                // Update save name
                updateSaveName();
            } else {
                imagePathInput.value = "";
                defaultKeywordsInput.value = "";
                saveNameSpan.textContent = "Select category first";
            }
        }
        
        // Update save name for image
        function updateSaveName() {
            const category = categorySelect.value;
            if (!category) {
                saveNameSpan.textContent = "Select category first";
                return;
            }
            
            const counter = itemCounters[category];
            let fileName;
            
            switch(category) {
                case 'Education': fileName = `edu${counter}.jpg`; break;
                case 'Medical': fileName = `med${counter}.jpg`; break;
                case 'Scientific': fileName = `sci${counter}.jpg`; break;
                case 'Industry': fileName = `ind${counter}.jpg`; break;
                case 'Research': fileName = `res${counter}.jpg`; break;
                case 'Project': fileName = `pro${counter}.jpg`; break;
                default: fileName = `item${counter}.jpg`;
            }
            
            saveNameSpan.textContent = fileName;
        }
        
        // Download image to local directory
        function downloadImage() {
            if (!croppedImageData) {
                alert('Please crop an image first');
                return;
            }
            
            const category = categorySelect.value;
            if (!category) {
                alert('Please select a category first');
                return;
            }
            
            const counter = itemCounters[category];
            let fileName;
            
            switch(category) {
                case 'Education': fileName = `edu${counter}.jpg`; break;
                case 'Medical': fileName = `med${counter}.jpg`; break;
                case 'Scientific': fileName = `sci${counter}.jpg`; break;
                case 'Industry': fileName = `ind${counter}.jpg`; break;
                case 'Research': fileName = `res${counter}.jpg`; break;
                case 'Project': fileName = `pro${counter}.jpg`; break;
                default: fileName = `item${counter}.jpg`;
            }
            
            // Create download link
            const link = document.createElement('a');
            link.href = croppedImageData;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Increment counter for next item
            itemCounters[category]++;
            localStorage.setItem('itemCounters', JSON.stringify(itemCounters));
            updateSaveName();
            handleCategoryChange(); // Update image path for next item
        }
        
        // Format MRP price as user types - Simple formatting
        function formatMRPPrice() {
            let value = mrpPriceInput.value.replace(/[^0-9]/g, '');
            
            if (value) {
                // Convert to number
                let num = parseInt(value, 10);
                if (!isNaN(num) && num > 0) {
                    // Format with Indian numbering system
                    mrpPriceInput.value = num.toLocaleString('en-IN');
                }
            }
        }
        
        // Calculate buy price based on MRP and discount
        function calculateBuyPrice() {
            // Extract numeric value from MRP
            const mrpText = mrpPriceInput.value;
            const mrp = parseFloat(mrpText.replace(/[^0-9]/g, ''));
            const discount = parseFloat(discountInput.value) || 0;
            
            if (!isNaN(mrp) && !isNaN(discount)) {
                const buyPrice = mrp * (1 - discount / 100);
                const roundedPrice = Math.ceil(buyPrice * 100) / 100; // Round up to 2 decimal places
                buyPriceInput.value = roundedPrice.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + "/-";
            } else {
                buyPriceInput.value = "";
            }
        }
        
        // Capitalize first letter of each word in item name
        function capitalizeFirstLetters() {
            const words = itemNameInput.value.split(' ');
            const capitalized = words.map(word => {
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }
                return word;
            });
            itemNameInput.value = capitalized.join(' ');
        }
        
        // Show success message
        function showSuccessMessage() {
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }
        
        // Update Specifications counter
        function updateSpecsCounter() {
            const lines = specificationsInput.value.split('\n').filter(line => line.trim() !== '');
            const lineCount = lines.length;
            const maxLineLength = lines.length > 0 ? Math.max(...lines.map(line => line.length)) : 0;
            
            specsLineCount.textContent = lineCount;
            specsMaxChars.textContent = maxLineLength;
            
            // Check if limits exceeded
            if (lineCount > 6 || maxLineLength > 40) {
                specsLineCount.classList.add('error');
                specsMaxChars.classList.add('error');
            } else {
                specsLineCount.classList.remove('error');
                specsMaxChars.classList.remove('error');
            }
            
            // Enforce line limit
            if (lines.length > 6) {
                specificationsInput.value = lines.slice(0, 6).join('\n');
                updateSpecsCounter(); // Update counter again
            }
            
            // Enforce character limit per line
            if (maxLineLength > 40) {
                const newLines = lines.map(line => line.substring(0, 40));
                specificationsInput.value = newLines.join('\n');
                updateSpecsCounter(); // Update counter again
            }
        }
        
        // Update Descriptions counter
        function updateDescCounter() {
            const lines = descriptionsInput.value.split('\n').filter(line => line.trim() !== '');
            const lineCount = lines.length;
            const maxLineLength = lines.length > 0 ? Math.max(...lines.map(line => line.length)) : 0;
            
            descLineCount.textContent = lineCount;
            descMaxChars.textContent = maxLineLength;
            
            // Check if limits exceeded
            if (lineCount > 6 || maxLineLength > 40) {
                descLineCount.classList.add('error');
                descMaxChars.classList.add('error');
            } else {
                descLineCount.classList.remove('error');
                descMaxChars.classList.remove('error');
            }
            
            // Enforce line limit
            if (lines.length > 6) {
                descriptionsInput.value = lines.slice(0, 6).join('\n');
                updateDescCounter(); // Update counter again
            }
            
            // Enforce character limit per line
            if (maxLineLength > 40) {
                const newLines = lines.map(line => line.substring(0, 40));
                descriptionsInput.value = newLines.join('\n');
                updateDescCounter(); // Update counter again
            }
        }
        
        // Add item to text file - FIXED VERSION
        function addItem() {
            const category = categorySelect.value;
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            // Validate required fields
            if (!itemNameInput.value.trim()) {
                alert('Please enter Item Name');
                itemNameInput.focus();
                return;
            }
            
            // Get MRP value and format for JSON
            const mrpValue = mrpPriceInput.value.replace(/[^0-9]/g, '');
            if (!mrpValue) {
                alert('Please enter MRP Price');
                mrpPriceInput.focus();
                return;
            }
            
            // Format MRP for display in JSON
            const mrpNumber = parseInt(mrpValue, 10);
            const formattedMRP = mrpNumber.toLocaleString('en-IN') + ".00/-";
            
            // Get discount value
            const discountValue = discountInput.value || "0";
            
            // Get specifications and descriptions as arrays
            const specsArray = specificationsInput.value
                .split('\n')
                .filter(line => line.trim() !== '')
                .map(line => line.substring(0, 40)); // Limit to 40 chars
            
            const descArray = descriptionsInput.value
                .split('\n')
                .filter(line => line.trim() !== '')
                .map(line => line.substring(0, 40)); // Limit to 40 chars
            
            // Get keywords from default keywords (split by commas)
            const keywordsArray = defaultKeywordsInput.value
                .split(',')
                .map(keyword => keyword.trim())
                .filter(keyword => keyword !== '');
            
            // Create item object
            const item = {
                name: itemNameInput.value.substring(0, 25), // Limit to 25 chars
                category: category,
                image: imagePathInput.value,
                mrpPrice: formattedMRP,
                discount: discountValue + "%",
                bestBuyPrice: buyPriceInput.value,
                warranty: warrantyInput.value.substring(0, 40), // Limit to 40 chars
                specifications: specsArray,
                description: descArray,
                keywords: keywordsArray
            };
            
            // Format as JSON
            const itemJSON = JSON.stringify(item, null, 2) + ",\n";
            
            // Save to file using FileSaver.js approach
            saveItemToFile(category, itemJSON);
            
            // Show success message
            showSuccessMessage();
            
            // Reset form for next item
            resetForm();
        }
        
        // Save item to text file - Working version
        function saveItemToFile(category, content) {
            const fileName = filePaths[category];
            
            // Check if file exists in localStorage
            const storageKey = `sparrowweb_${category.toLowerCase()}`;
            let existingContent = localStorage.getItem(storageKey) || '';
            
            // Append new content
            existingContent += content;
            
            // Save to localStorage (simulating file save)
            localStorage.setItem(storageKey, existingContent);
            
            // Also create a downloadable file
            const blob = new Blob([existingContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Update counter
            itemCounters[category]++;
            localStorage.setItem('itemCounters', JSON.stringify(itemCounters));
        }
        
        // Reset form
        function resetForm() {
            itemNameInput.value = '';
            mrpPriceInput.value = '';
            discountInput.value = '';
            buyPriceInput.value = '';
            warrantyInput.value = '';
            specificationsInput.value = '';
            descriptionsInput.value = '';
            // Keep category and default keywords
            handleCategoryChange();
            
            // Update counters
            updateSpecsCounter();
            updateDescCounter();
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>
